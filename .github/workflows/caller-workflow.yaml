name: Building and deploying the test helm charts.
on:
  push:
    branches:
      - develop
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
      - develop

jobs:
  call-workflow-staging-infra-deploy:
    if: github.ref == 'refs/heads/develop'
    uses: ./.github/workflows/helm-deploy.yaml
    with:
      releaseEnv: staging
      chartName: infra-chart
    secrets:
      KUBECONFIG: ${{ secrets.KUBECONFIG }}

  call-workflow-staging-deploy:
    if: github.ref == 'refs/heads/develop'
    needs:
      - call-workflow-staging-infra-deploy
    uses: ./.github/workflows/helm-deploy.yaml
    with:
      releaseEnv: staging
      chartName: testing-chart
    secrets:
      KUBECONFIG: ${{ secrets.KUBECONFIG }}

  call-workflow-production-infra-deploy:
    if: github.ref == 'refs/heads/main'
    needs:
      - call-workflow-staging-infra-deploy
      - call-workflow-staging-deploy
    uses: ./.github/workflows/helm-deploy.yaml
    with:
      releaseEnv: production
      chartName: infra-chart
    secrets:
      KUBECONFIG: ${{ secrets.KUBECONFIG }}

  call-workflow-production-deploy:
    if: github.ref == 'refs/heads/main'
    needs:
      - call-workflow-production-infra-deploy
      - call-workflow-staging-deploy
    uses: ./.github/workflows/helm-deploy.yaml
    with:
      releaseEnv: production
      chartName: testing-chart
    secrets:
      KUBECONFIG: ${{ secrets.KUBECONFIG }}